<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Calculator</title>
  <meta name="description" content="A simple, offline-ready calculator that works also as a PWA." />

  <link rel="manifest" href="manifest.webmanifest">

  <link rel="icon" type="image/png" href="icon-512.png">

  <link rel="apple-touch-icon" href="icon-512.png">

  <meta name="theme-color" content="#0b0d12">
  <meta name="background-color" content="#0b0d12">

  <meta name="msapplication-TileImage" content="icon-512.png">
  <meta name="msapplication-TileColor" content="#0b0d12">
  
  
<style>
    :root{--bg:#0b0d12;--panel:#121622;--btn:#1b2232;--btn-alt:#24304a;--text:#e9edf5;--muted:#95a3bf;--accent:#6aa1ff;--danger:#ff6b6b;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);}
    @media (prefers-color-scheme: light){:root{--bg:#f5f7fb;--panel:#ffffff;--btn:#f1f4fb;--btn-alt:#e7ecf8;--text:#0b0d12;--muted:#5a6782;--accent:#2f6dff;--danger:#d14343;}}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font:18px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;background:radial-gradient(1200px 800px at 80% -20%, rgba(106,161,255,.15), transparent 60%),var(--bg);color:var(--text);display:grid;place-items:center;-webkit-tap-highlight-color: transparent;}
    
    /* Die Breite bleibt im Advanced-Modus KONSTANT */
    .app{width:min(460px,95vw);padding:18px;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01)),var(--panel);box-shadow:var(--shadow); transition: all 0.3s ease;}
    
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px} h1{font-size:20px;margin:0;letter-spacing:.3px;font-weight:700} .credits{font-size:12px;color:var(--muted)}
    .display{position:relative;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.06));padding:20px;min-height:100px;box-shadow:inset 0 2px 12px rgba(0,0,0,.25)}
    .expr{font-size:15px;color:var(--muted);min-height:20px;word-wrap:break-word} .value{font-size:38px;line-height:1.3;font-variant-numeric:tabular-nums;word-wrap:break-word}
    
    .keys-container{margin-top:14px;} 
    
    /* Standard-Tastenfeld (4 Spalten) */
    .keys{display:grid;grid-template-columns:repeat(4,1fr);gap:12px; } 
    
 /* Advanced Tastenfeld (NEU: 4 Spalten) */
.keys.advanced-keys{
    grid-template-columns:repeat(4,1fr); /* Jetzt 4 Spalten, passend zum Standardfeld */
    gap:12px;
    margin-bottom: 0;
    display: grid; 
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, opacity 0.4s ease, margin-bottom 0.4s ease;
}
    
/* Advanced Modus: Tastenfeld wird sichtbar */
.app.advanced .keys.advanced-keys{
    max-height: 200px; /* Platz für 3 Reihen Tasten + Gaps */
    opacity: 1;
    margin-bottom: 12px;
}
    
    /* Standard Button Styling */
    button{appearance:none;border:none;border-radius:16px;background:var(--btn);color:var(--text);padding:22px;font-size:22px;cursor:pointer;box-shadow:var(--shadow);transition: transform .06s ease, filter .2s ease;touch-action: manipulation;} 
    
/* ⭐ KORREKTUR: Advanced Key Styling - Kleinere Größe und Schrift */
.advanced-key{
    padding: 12px;
    font-size: 16px; 
    grid-column: span 1; /* Jede Advanced-Taste nimmt nur 1 Spalte ein */
}
    
    button:active{transform:scale(0.96)} button:focus-visible{outline:2px solid var(--accent);outline-offset:2px} button[data-variant="op"]{background:var(--btn-alt)} button[data-variant="accent"]{background:linear-gradient(180deg, rgba(106,161,255,.22), rgba(106,161,255,.1));} button[data-variant="danger"]{background:linear-gradient(180deg, rgba(255,107,107,.25), rgba(255,107,107,.12));} .span-2{grid-column:span 2} .sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
    .footer{margin-top:14px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;flex-wrap:wrap} .switcher{display:flex;gap:8px} .switch{background:transparent;box-shadow:none;border:1px solid rgba(255,255,255,.08);padding:8px 10px;font-size:12px}
</style>
</head>
<body>
  <main class="app" role="application" aria-label="Calculator">
    <div class="top">
      <h1>Calculator</h1>
      <div class="credits" id="status">Normal</div>
    </div>

    <section class="display" aria-live="polite">
      <div class="expr" id="expr"></div>
      <div class="value" id="value">0</div>
    </section>

    <div class="keys-container">
      <section class="keys advanced-keys" aria-label="Advanced functions keypad">
        <button data-fn="sin" data-variant="op" class="advanced-key" title="Sine">sin</button>
        <button data-fn="cos" data-variant="op" class="advanced-key" title="Cosine">cos</button>
        <button data-fn="tan" data-variant="op" class="advanced-key" title="Tangent">tan</button>
        <button data-fn="sqrt" data-variant="op" class="advanced-key" title="Square Root">√</button>
        <button data-fn="pow2" data-variant="op" class="advanced-key" title="Square">x²</button>
        <button data-op="yroot" data-variant="op" class="advanced-key" title="y-th root">ⁿ√x</button>
        <button data-fn="log10" data-variant="op" class="advanced-key" title="Logarithm (Base 10)">log</button>
        <button data-fn="ln" data-variant="op" class="advanced-key" title="Natural Logarithm (Base e)">ln</button>
        <button data-op="logx" data-variant="op" class="advanced-key" title="Logarithm (Base x)">logᵪ</button>
        <button data-const="PI" data-variant="op" class="advanced-key" title="Pi (π)">π</button>
        <button data-const="E" data-variant="op" class="advanced-key" title="Euler's Number (e)">e</button>
        <button data-fn="fact" data-variant="op" class="advanced-key" title="Factorial">n!</button>
      </section>

      <section class="keys" aria-label="Standard calculator keypad">
        <button data-key="Escape" data-variant="danger" title="Clear (Esc)">AC</button>
        <button data-key="Backspace" title="Backspace">⌫</button>
        <button data-op="%" data-variant="op" title="Percent">%</button>
        <button data-op="/" data-variant="op" title="Divide">÷</button>
        <button data-num="7">7</button>
        <button data-num="8">8</button>
        <button data-num="9">9</button>
        <button data-op="*" data-variant="op" title="Multiply">×</button>
        <button data-num="4">4</button>
        <button data-num="5">5</button>
        <button data-num="6">6</button>
        <button data-op="-" data-variant="op" title="Minus">−</button>
        <button data-num="1">1</button>
        <button data-num="2">2</button>
        <button data-num="3">3</button>
        <button data-op="+" data-variant="op" title="Plus">+</button>
        <button data-num="0" class="span-2">0</button>
        <button data-dot=".">.</button>
        <button data-equals="=" data-variant="accent" title="Equals (=)">=</button>
        <button data-paren="(" title="Left parenthesis">(</button>
        <button data-paren=")" title="Right parenthesis">)</button>
        <button data-op="^" data-variant="op" title="Power">^</button>
        <button data-sign="±" title="Toggle sign">±</button>
      </section>
    </div>

    <div class="footer">
      <span>Keys: 0–9 • . • + − × ÷ • ( ) • % ^ • Enter • Esc • Backspace</span>
      <div class="switcher">
        <button class="switch" id="copy">Copy</button>
        <button class="switch" id="swap">Swap</button>
      </div>
    </div>
  </main>

<script>
    // --- Calculator logic embedded ---
    const appEl = document.querySelector('.app');
    const valueEl = document.getElementById('value');
    const exprEl = document.getElementById('expr');
    const statusEl = document.getElementById('status');
    const advancedKeysEl = document.querySelector('.advanced-keys');
    
    // Zustand
    let expr = '', currentNumber = '0';
    let isResult = false; 
    let lastResult = null; 
    let isAdvanced = false; // NEU: Modus-Zustand

    const isOp = c => ['+','-','*','/','%','^','yroot','logx'].includes(c);
    const isNumChar = c => /[\d.−]/.test(c);

    function updateDisplay(){
      // Ersetze interne Operatoren durch Anzeigesymbole
      let displayExpr = expr
          .replace(/\*/g, '×').replace(/\//g, '÷').replace(/-/g, '−')
          .replace(/\^/g, '^').replace(/yroot/g, 'ⁿ√')
          .replace(/logx/g, 'logᵪ');
      

      // Ersetze Funktionsnamen durch ihre Display-Form
      displayExpr = displayExpr.replace(/pow2\((.*?)\)/g, '$1²');
      displayExpr = displayExpr.replace(/sqrt\(/g, '√('); 
  

      exprEl.textContent = displayExpr;
      valueEl.textContent = currentNumber;
      statusEl.textContent = isAdvanced ? 'Advanced' : 'Normal';
    }

    // --- Core Logic (Unverändert/Korrigiert) ---

    function pushNum(n){
      if(isResult){ 
          expr = ''; 
          isResult = false;
          lastResult = null; 
      }

      const lastChar = expr.slice(-1);
      if(isOp(lastChar) || lastChar === '(' || expr === ''){
        expr += String(n);
        currentNumber = String(n);
      } else {
        if(currentNumber === '0'){
          expr = expr.slice(0, expr.length - currentNumber.length);
        } else {
          expr = expr.slice(0, expr.length - currentNumber.length);
        }
        
        if(currentNumber === '0') currentNumber = String(n);
        else currentNumber += String(n);
        
        expr += currentNumber;
      }
      updateDisplay();
    }

    function pushDot(){
      if(isResult){ expr = '0'; isResult = false; }

      const lastChar = expr.slice(-1);

      if(expr === '' || isOp(lastChar) || lastChar === '('){
        expr += '0.';
        currentNumber = '0.';
      } else if(!currentNumber.includes('.')){
        expr = expr.slice(0, expr.length - currentNumber.length);
        currentNumber += '.';
        expr += currentNumber;
      }
      updateDisplay();
    }

    function pushOp(op){
      if(isResult){
          if (lastResult !== null) {
              expr = currentNumber; 
          } else {
              expr = '0';
          }
          
          expr += op;  
          isResult = false;
          currentNumber = '0'; 
          updateDisplay();
          return;
      }
      
      if(isOp(expr.slice(-1))){
        expr = expr.slice(0,-1) + op;
      } 
      else if(expr !== ''){
        expr += op;
        currentNumber = '0'; 
      }
      updateDisplay();
    }
    
    function pushParen(p){
      if(isResult){ expr = ''; isResult = false; lastResult = null; }
      
      const lastChar = expr.slice(-1);
      
      if(p === '('){
        if(/[\d.)]/.test(lastChar) && expr !== '0') expr += '*';
        expr += '(';
      } else if (p === ')'){
        const opens = (expr.match(/\(/g) || []).length;
        const closes = (expr.match(/\)/g) || []).length;
        
        if(opens > closes && !isOp(lastChar) && lastChar !== '('){
          expr += ')';
        }
      }
      currentNumber = '0';
      updateDisplay();
    }

    function backspace(){
      if(isResult){ clearAll(); return; }

      if(expr.length === 0 || expr === '0') {
        clearAll(); return;
      }
      
      expr = expr.slice(0, -1);
      
      if(!isOp(expr.slice(-1)) && expr.slice(-1) !== '(' && expr.slice(-1) !== ')'){
        const match = expr.match(/(-?\d+\.?\d*|\.\d+)$/); 
        currentNumber = match ? match[0].replace('-', '−') : '0';
      } else {
        currentNumber = '0';
      }
      
      if(expr.length === 0) currentNumber = '0';
      updateDisplay();
    }
    
    function toggleSign(){
      if(isResult){
          // Toggle des Ergebnisses
          const numericValue = lastResult || compute(currentNumber.replace(/−/g, '-'));
          const newValue = -numericValue;
          
          expr = formatNumber(numericValue) + '=' + formatNumber(newValue);
          currentNumber = formatNumber(newValue);
          lastResult = newValue;
          updateDisplay();
          return;
      }
      
      if(currentNumber === '0') return;

      // Toggle der aktuellen Zahl im Ausdruck
      const exprBase = expr.slice(0, expr.length - currentNumber.length);
      const absValue = currentNumber.replace(/−/g, '');

      if(currentNumber.startsWith('−')){
        currentNumber = absValue;
        expr = exprBase.replace(/-$/, '') + currentNumber;
      } else {
        currentNumber = '−' + absValue;
        // Füge '-' nur hinzu, wenn kein Operator davor steht, sonst ist es unäres Minus
        if(!isOp(exprBase.slice(-1)) && exprBase.slice(-1) !== '(' && exprBase !== '') {
             expr = exprBase + '-' + absValue;
        } else {
             expr = exprBase + '-' + absValue;
        }
      }
      updateDisplay();
    }

    function clearAll(){
      expr = ''; 
      currentNumber = '0'; 
      isResult = false;
      lastResult = null; 
      updateDisplay();
    }

    // --- NEUE ADVANCED LOGIK ---

    function pushFunction(fn){
        if(isResult){ expr = ''; isResult = false; }

        const lastChar = expr.slice(-1);

        // Implizite Multiplikation: Wenn Zahl oder Klammer davor, füge '*' hinzu
        if(isNumChar(lastChar) || lastChar === ')'){
             expr += '*';
        }

        // Für Funktionen wie 'sin', 'log', 'sqrt'
        expr += fn + '(';
        currentNumber = '0';
        updateDisplay();
    }

    function pushConstant(c){
        if(isResult){ expr = ''; isResult = false; }
        
        const lastChar = expr.slice(-1);
        const value = (c === 'PI') ? Math.PI.toFixed(12) : Math.E.toFixed(12);

        // Implizite Multiplikation
        if(isNumChar(lastChar) || lastChar === ')'){
             expr += '*';
        }

        expr += value;
        currentNumber = formatNumber(value);
        updateDisplay();
    }

    // ⭐ NEU: Moduswechsel-Funktion
    function toggleMode(){
        isAdvanced = !isAdvanced;
        appEl.classList.toggle('advanced', isAdvanced);
        updateDisplay();
        // Optional: clearAll() beim Moduswechsel, um Verwirrung zu vermeiden
        clearAll();
    }


 // --- Berechnungslogik (erweitert für neue Funktionen) ---

function equals(){
    let exprToCalc = expr;
    if (exprToCalc === '' || exprToCalc.endsWith('=')) return;
    
    const opens = (exprToCalc.match(/\(/g)||[]).length;
    const closes = (exprToCalc.match(/\)/g)||[]).length;
    
    // ⭐ ANPASSUNG: Fehlende Klammern zur Berechnung und zur Anzeige hinzufügen
    const neededCloses = opens - closes;
    if(neededCloses > 0) {
        const closingParens = ')'.repeat(neededCloses);
        exprToCalc += closingParens; // Für die Berechnung
        expr += closingParens;      // Für die Anzeige
    }
    
    // Entferne abschließende Operatoren oder öffnende Klammern vor der Berechnung
    while(isOp(exprToCalc.slice(-1)) || exprToCalc.slice(-1) === '('){
        exprToCalc = exprToCalc.slice(0, -1);
        // ⭐ Anpassung: Auch von der Anzeige-Variable entfernen
        expr = expr.slice(0, -1);
    }

    let finalExprForCalc = exprToCalc.replace(/−/g, '-');
    
    const parts = finalExprForCalc.split('=');
    if (parts.length > 1) {
        finalExprForCalc = parts.pop(); 
        if (lastResult !== null) {
            const startChar = finalExprForCalc.charAt(0);
            if (isOp(startChar) || startChar === '(') {
                finalExprForCalc = lastResult + finalExprForCalc;
            }
        }
    } 
    
    // Der Rest der Funktion (try/catch Block) muss beibehalten werden,
    // um das Ergebnis zu berechnen und die finale Anzeige zu aktualisieren.
    try{
        const result = compute(finalExprForCalc); 
        
        currentNumber = formatNumber(result);
        
        // Die Variable 'expr' enthält jetzt den korrigierten Ausdruck (mit Klammern)
        // und wird hier final für die Anzeige vorbereitet.
        expr = expr.replace(/\*/g, '×').replace(/\//g, '÷').replace(/-/g, '−') + '=' + currentNumber;
        
        isResult = true;
        lastResult = result; 
        updateDisplay();
    }catch(e){
        currentNumber = 'Error'; 
        expr = expr.replace(/\*/g, '×').replace(/\//g, '÷').replace(/-/g, '−') + '=';
        isResult = true;
        lastResult = null;
        updateDisplay();
        console.error("Calculation Error:", e);
    }
}

    function formatNumber(n){if(!isFinite(n)) return 'Error'; const abs=Math.abs(n); if(abs!==0&&(abs<1e-6||abs>=1e12)) return n.toExponential(8).replace(/\.0+e/,'e'); return n.toLocaleString(undefined,{maximumFractionDigits:12});}
    
    // ⭐ ERWEITERT: compute-Funktion für mathematische Funktionen
    function compute(s){
      s = s.replace(/([+\-*/%^])\1+/g, '$1').replace(/=/g, ''); 

      // Ersetze Spezialfunktionen in ihren Token-Form
      s = s.replace(/sin\(/g, 'sin(').replace(/cos\(/g, 'cos(').replace(/tan\(/g, 'tan(');
      s = s.replace(/sqrt\(/g, 'sqrt(').replace(/log10\(/g, 'log10(').replace(/ln\(/g, 'ln(');
      s = s.replace(/pow2\(/g, 'pow2(').replace(/fact\(/g, 'fact(');
      
      // Tokenisierung (jetzt mit Funktionsnamen)
      const tokens = [];
      const re = /(-?\d*\.?\d+)|[()+\-*/%^]|(sin|cos|tan|sqrt|log10|ln|pow2|fact|yroot|logx)/g; 
      let m; 
      while((m=re.exec(s))){tokens.push(m[0]);} 

      // Unäres Minus korrigieren
      for(let i=0;i<tokens.length;i++){
        if(tokens[i]==='-'){
          if(i===0 || (isOp(tokens[i-1]) || tokens[i-1]==='(' || tokens[i-1].match(/sin|cos|tan|sqrt|log10|ln|pow2|fact/))){
            tokens[i]='u-'; 
          }
        }
      } 
      
      const prec={'u-':4,'^':3,'*':2,'/':2,'%':2,'yroot':3,'logx':3,'+':1,'-':1, 'sin':5,'cos':5,'tan':5,'sqrt':5,'log10':5,'ln':5,'pow2':5,'fact':5}; 
      const rightAssoc={'^':true,'u-':true}; 
      
      // Shunting-Yard (Infix zu Postfix)
      const out=[],stack=[]; 
      for(const t of tokens){
        if(!isNaN(parseFloat(t)) && isFinite(t)){ 
          out.push(Number(t)); 
        } else if(t in prec){ 
          while(stack.length){
            const top=stack[stack.length-1]; 
            if(top in prec){
              if((rightAssoc[t]&&prec[t]<prec[top])||(!rightAssoc[t]&&prec[t]<=prec[top])){
                out.push(stack.pop());
              } else break;
            } else break;
          } 
          stack.push(t);
        } else if(t.match(/sin|cos|tan|sqrt|log10|ln|pow2|fact/)){ // Funktion
            stack.push(t);
        } else if(t==='('){ 
          stack.push(t); 
        } else if(t===')'){ 
          while(stack.length&&stack[stack.length-1]!=='(') out.push(stack.pop()); 
          if(stack.pop()!=='(') throw new Error("Mismatched parentheses");
          // Nach schließender Klammer, Pop die Funktion, falls vorhanden
          const top = stack[stack.length-1];
          if(top.match(/sin|cos|tan|sqrt|log10|ln|pow2|fact/)) out.push(stack.pop());
        } 
      } 
      while(stack.length){
        const x=stack.pop(); 
        if(x==='('||x===')') throw new Error("Mismatched parentheses"); 
        out.push(x);
      } 
      
      // Postfix (RPN) Auswertung
      const st=[]; 
      for(const t of out){
        if(typeof t==='number') st.push(t); 
        else if(t==='u-') st.push(-st.pop()); 
        else if(t.match(/sin|cos|tan|sqrt|log10|ln|pow2|fact/)){
            const a = st.pop();
            let r;
            switch(t){
                case 'sin': r = Math.sin(a); break;
                case 'cos': r = Math.cos(a); break;
                case 'tan': r = Math.tan(a); break;
                case 'sqrt': r = Math.sqrt(a); break;
                case 'log10': r = Math.log10(a); break;
                case 'ln': r = Math.log(a); break;
                case 'pow2': r = Math.pow(a, 2); break;
                case 'fact': 
                    // Einfache Fakultät (nur für nicht-negative Ganzzahlen)
                    if (a < 0 || a !== Math.floor(a)) throw new Error("Factorial error");
                    r = 1;
                    for(let i=2; i<=a; i++) r *= i;
                    break;
                default: throw new Error("Unknown function");
            }
            st.push(r);
        }
        else {
          if(st.length < 2) throw new Error("Insufficient operands");
          const b=st.pop(); 
          const a=st.pop(); 
          let r; 
          switch(t){
            case '+':r=a+b;break;
            case '-':r=a-b;break;
            case '*':r=a*b;break;
            case '/':r=b===0?Infinity:a/b;break;
            case '%':r=a%b;break;
            case '^':r=Math.pow(a,b);break;
            case 'yroot':r=Math.pow(b, 1/a);break; // a ⁿ√ b (Basis a, Exponent 1/a)
            case 'logx':r=Math.log(b) / Math.log(a);break; // logₐ(b)
            default:throw new Error("Unknown operator");
          } 
          st.push(r);
        } 
      } 
      if(st.length!==1) throw new Error("Invalid expression structure"); 
      return st[0];
    }


    // --- Event Listener ---

    document.querySelectorAll('button[data-num]').forEach(b=>b.addEventListener('click',()=>pushNum(b.dataset.num),{passive:true}));
    document.querySelectorAll('button[data-op]').forEach(b=>b.addEventListener('click',()=>pushOp(b.dataset.op),{passive:true}));
    document.querySelectorAll('button[data-fn]').forEach(b=>b.addEventListener('click',()=>pushFunction(b.dataset.fn),{passive:true})); // NEU
    document.querySelectorAll('button[data-const]').forEach(b=>b.addEventListener('click',()=>pushConstant(b.dataset.const),{passive:true})); // NEU

    document.querySelector('button[data-dot]')?.addEventListener('click',pushDot,{passive:true});
    document.querySelector('button[data-equals]')?.addEventListener('click',equals,{passive:true});
    document.querySelector('button[data-sign]')?.addEventListener('click',toggleSign,{passive:true});
    document.querySelector('button[title="Clear (Esc)"]')?.addEventListener('click',clearAll,{passive:true});
    document.querySelector('button[title="Backspace"]')?.addEventListener('click',backspace,{passive:true});
    document.querySelectorAll('button[data-paren]').forEach(b=>b.addEventListener('click',()=>pushParen(b.dataset.paren),{passive:true}));
    
    document.getElementById('copy').addEventListener('click',()=>{const txt=valueEl.textContent||''; navigator.clipboard?.writeText(txt).then(()=>{flash('Copied');}).catch(()=>{flash('Copy failed');})});
    
    document.getElementById('swap').addEventListener('click', toggleMode, {passive:true}); // NEU: Swap Button

    function flash(msg){statusEl.textContent=msg; setTimeout(()=>statusEl.textContent=isAdvanced ? 'Advanced' : 'Normal',1200);}
    
    // Tastatur-Handler erweitert für die neuen Funktionen (z.B. s für sin)
    window.addEventListener('keydown',(e)=>{
      const k=e.key;
      if(/^[0-9]$/.test(k)){pushNum(k);e.preventDefault();return;} 
      if(k==='.') {pushDot();e.preventDefault();return;} 
      if(['+','-','*','/','%','^'].includes(k)){pushOp(k);e.preventDefault();return;} 
      if(k==='('||k===')'){pushParen(k);e.preventDefault();return;} 
      if(k==='Enter'||k==='='){e.preventDefault();equals();return;} 
      if(k==='Backspace'){backspace();e.preventDefault();return;} 
      if(k==='Escape'){clearAll();e.preventDefault();return;}
      
      // Advanced Key Shortcuts
      if(isAdvanced) {
          if(k.toLowerCase() === 's') { pushFunction('sin'); e.preventDefault(); return; }
          if(k.toLowerCase() === 'c') { pushFunction('cos'); e.preventDefault(); return; }
          if(k.toLowerCase() === 't') { pushFunction('tan'); e.preventDefault(); return; }
          if(k.toLowerCase() === 'r') { pushFunction('sqrt'); e.preventDefault(); return; } // r for root
          if(k.toLowerCase() === 'p') { pushConstant('PI'); e.preventDefault(); return; } // p for Pi
      }
    });
    
    // Initialisierung des Displays auf 'Normal'
    updateDisplay();

    // --- Service Worker for offline GitHub Pages ---
    if('serviceWorker' in navigator){
     navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registered')).catch(console.error);
    }
  </script>
</body>
</html>
